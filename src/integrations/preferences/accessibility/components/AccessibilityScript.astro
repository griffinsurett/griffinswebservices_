---
// src/integrations/preferences/accessibility/components/AccessibilityScript.astro
/**
 * Accessibility Script Initialization
 *
 * Inline script that applies saved accessibility preferences on page load.
 * Runs synchronously to prevent flash of unstyled content (FOUC).
 *
 * Two parts:
 * 1. Inline script (is:inline) - applies CSS attributes immediately, blocking
 * 2. Deferred script - initializes reading guide/mask event handlers after DOM ready
 */
---

<!-- Critical: Apply accessibility preferences before content renders -->
<script is:inline>
  (function() {
    try {
      var raw = localStorage.getItem('user-a11y-prefs');
      if (!raw) return;
      var prefs = JSON.parse(raw);
      if (!prefs || !prefs.text || !prefs.visual || !prefs.reading || !prefs.content) return;
      var root = document.documentElement;

      // TEXT & TYPOGRAPHY
      var weightMap = { normal: '400', semibold: '600', bold: '700' };
      var resolvedWeight = weightMap[prefs.text.fontWeight] || '400';
      root.style.setProperty('--a11y-font-size', prefs.text.fontSize + '%');
      root.style.setProperty('--a11y-line-height', String(prefs.text.lineHeight));
      root.style.setProperty('--a11y-letter-spacing', prefs.text.letterSpacing + 'em');
      root.style.setProperty('--a11y-word-spacing', prefs.text.wordSpacing + 'em');
      root.style.setProperty('--a11y-font-weight', resolvedWeight);
      root.style.setProperty('--a11y-text-align', prefs.text.textAlign);
      root.setAttribute('data-a11y-font', prefs.text.fontFamily);

      // Set data attributes to trigger overrides when changed from defaults
      if (prefs.text.lineHeight !== 1.5) {
        root.setAttribute('data-a11y-line-height', 'true');
      }
      if (prefs.text.letterSpacing !== 0) {
        root.setAttribute('data-a11y-letter-spacing', 'true');
      }
      if (prefs.text.wordSpacing !== 0) {
        root.setAttribute('data-a11y-word-spacing', 'true');
      }
      if (prefs.text.fontWeight !== 'normal') {
        root.setAttribute('data-a11y-font-weight', prefs.text.fontWeight);
      }
      if (prefs.text.textAlign !== 'left') {
        root.setAttribute('data-a11y-text-align', 'true');
      }

      // VISUAL ENHANCEMENTS
      root.setAttribute('data-a11y-links', prefs.visual.linkHighlight ? 'true' : 'false');
      root.setAttribute('data-a11y-titles', prefs.visual.titleHighlight ? 'true' : 'false');
      root.setAttribute('data-a11y-contrast', prefs.visual.contrastBoost ? 'boost' : 'normal');
      root.setAttribute('data-a11y-saturation', prefs.visual.saturation);

      // READING AIDS
      root.setAttribute('data-a11y-focus', prefs.reading.focusHighlight ? 'true' : 'false');
      root.setAttribute('data-a11y-cursor', prefs.reading.bigCursor ? 'big' : 'normal');
      root.setAttribute('data-a11y-mask', prefs.reading.readingMask ? 'true' : 'false');
      if (prefs.reading.pauseAnimations) {
        root.style.setProperty('--a11y-animation-duration', '0.01ms');
        root.setAttribute('data-a11y-animations', 'true');
      }

      // CONTENT SIMPLIFICATION
      root.setAttribute('data-a11y-images', prefs.content.hideImages ? 'hide' : 'show');
      root.setAttribute('data-a11y-sounds', prefs.content.muteSounds ? 'mute' : 'play');
      root.setAttribute('data-a11y-motion', prefs.content.reducedMotion ? 'reduced' : 'normal');

      // Store prefs for deferred handler initialization
      if (prefs.reading.readingGuide || prefs.reading.readingMask) {
        window.__a11yPrefs = prefs;
      }
    } catch (e) {}
  })();
</script>

<!-- Deferred: Initialize reading guide/mask event handlers after DOM ready -->
<script>
  (function() {
    function initA11yHandlers() {
      const prefs = (window as any).__a11yPrefs;
      if (!prefs) return;
      const root = document.documentElement;

      // Reading Guide
      if (prefs.reading.readingGuide && !document.querySelector('[data-reading-guide]')) {
        const guide = document.createElement('div');
        guide.setAttribute('data-reading-guide', 'true');
        guide.style.cssText = 'position:fixed;left:0;right:0;height:2px;background-color:rgba(255,0,0,0.6);pointer-events:none;z-index:9999;box-shadow:0 0 8px rgba(255,0,0,0.4);';
        document.body.appendChild(guide);
        document.addEventListener('mousemove', (e) => {
          guide.style.top = e.clientY + 'px';
        }, { passive: true });
      }

      // Reading Mask cursor tracking
      if (prefs.reading.readingMask) {
        document.addEventListener('mousemove', (e) => {
          root.style.setProperty('--cursor-x', e.clientX + 'px');
          root.style.setProperty('--cursor-y', e.clientY + 'px');
        }, { passive: true });
      }

      delete (window as any).__a11yPrefs;
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initA11yHandlers);
    } else {
      initA11yHandlers();
    }
  })();
</script>
