---
// src/components/ContentRenderer/variants/AccordionVariant.astro
/**
 * AccordionVariant
 * Legacy-inspired accordion section with BorderTitle header + CTA block.
 * Still relies on ContentBridge so React accordions can consume Astro content.
 */

import type { BaseVariantProps } from "../ContentRenderer.types";
import ContentBridge from "../ContentBridge/ContentBridge.astro";
import Accordion from "@/components/LoopTemplates/Accordion";
import Button from "@/components/Button/Button";
import SectionHeader from "@/components/SectionHeader.astro";
import { shouldShowCollectionCTA } from "../utils/helpers";
import { toArray } from "@/utils/array";
import type { HeadingContent } from "@/content/schema";

interface Props extends BaseVariantProps {
  allowMultiple?: boolean;
  ctaHref?: string;
  ctaText?: string;
  ctaCollectionLabel?: string;
}

const {
  items = [],
  title,
  description,
  className = "",
  allowMultiple = false,
  collectionUrl,
  collectionTitle,
  id,
  ctaHref,
  ctaText,
  ctaCollectionLabel,
  showButtonSection = true,
  heading,
} = Astro.props as Props;

const safeItems = toArray(items);
const fallbackHeading = title ?? collectionTitle;
const headingSource = heading ?? fallbackHeading;
const isSegmentedHeading =
  typeof headingSource === "object" && headingSource !== null;
const segmentedHeading = isSegmentedHeading ? (headingSource as HeadingContent) : undefined;
const resolvedHeading =
  typeof headingSource === "string"
    ? headingSource
    : segmentedHeading?.text ?? fallbackHeading;
const headingPayload = segmentedHeading ?? resolvedHeading;
const showHeader = Boolean(
  (ctaCollectionLabel ?? collectionTitle ?? "").trim() ||
    headingPayload ||
    description,
);
---

<section
  id={id}
  class={`outer-section bg-bg relative overflow-hidden ${className}`.trim()}
>
  <div class="section-dim-border"></div>

  <div class="inner-section">
    {showHeader && (
        <SectionHeader
          title={(ctaCollectionLabel ?? collectionTitle ?? "").trim() || title || collectionTitle}
          heading={headingPayload}
          description={description}
          className="text-center max-w-3xl mx-auto"
          titleClassName="tracking-[0.25em]"
          headingClassName="h2 mb-4 text-4xl sm:text-[2.75rem] font-semibold text-heading"
        descriptionClassName="large-text text-text/80"
      />
    )}

    {safeItems.length > 0 && (
      <ContentBridge
        items={safeItems}
        bridgeId={id}
        className="mt-12"
      >
        <Fragment slot="default">
          <Accordion
            items={safeItems.map((item, index) => ({
              slug: item.slug,
              title: item.title || "Untitled",
              description: item.description,
              contentSlotId: `${id}-slot-${index}`,
            }))}
            allowMultiple={allowMultiple}
            className="space-y-4"
            client:visible
          />
        </Fragment>
      </ContentBridge>
    )}

    {showButtonSection &&
      shouldShowCollectionCTA(collectionUrl, safeItems.length) &&
      (ctaText || ctaCollectionLabel || collectionTitle) &&
      (ctaHref || collectionUrl) && (
      <div class="buttons-section-center">
        <Button
          client:visible
          href={ctaHref ?? collectionUrl}
          rightIcon="lu:arrow-right"
          variant="secondary"
          size="lg"
        >
          {ctaText ??
            `View All ${(ctaCollectionLabel ?? collectionTitle ?? "").trim()}`}
        </Button>
      </div>
    )}
  </div>
</section>
