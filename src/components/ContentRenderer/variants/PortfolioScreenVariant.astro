---
// PortfolioScreenVariant.astro
import { getImage } from "astro:assets";
import type { BaseVariantProps } from "../ContentRenderer.types";
import PortfolioScreenShowcase from "@/components/LoopTemplates/PortfolioScreenShowcase";
import { getImageAlt, resolveImageMetadata } from "@/utils/images";
import { toArray } from "@/utils/array";

interface Props extends BaseVariantProps {}

const {
  items = [],
  className = "",
  id,
} = Astro.props as Props;

const safeItems = toArray(items);

if (!safeItems.length) {
  return;
}

// Target widths for responsive images - max display is ~860px in the showcase
const IMAGE_WIDTHS = [320, 480, 640, 860];
const SIZES = "(max-width: 640px) 100vw, (max-width: 1024px) 80vw, 860px";

// Process items and generate optimized images
const processedItems = await Promise.all(
  safeItems.map(async (item, index) => {
    const primaryImage =
      (typeof item.image === "object" ? item.image : undefined) ??
      item.featuredImage ??
      item.bannerImage;

    const metadata = resolveImageMetadata(primaryImage);
    const altText = primaryImage
      ? getImageAlt(primaryImage, item.title ?? "Project preview")
      : item.title ?? "Project preview";

    // First image should be eager loaded for LCP optimization
    const isFirst = index === 0;

    if (!metadata) {
      return { data: item, mediaEntry: undefined };
    }

    // Generate optimized images at multiple widths
    const optimizedImages = await Promise.all(
      IMAGE_WIDTHS.map((width) =>
        getImage({
          src: metadata,
          width,
          format: "webp",
        })
      )
    );

    // Build srcSet from optimized images
    const srcSet = optimizedImages
      .map((img, i) => `${img.src} ${IMAGE_WIDTHS[i]}w`)
      .join(", ");

    // Use the largest optimized image as the default src
    const defaultImage = optimizedImages[optimizedImages.length - 1];

    return {
      data: item,
      mediaEntry: {
        src: defaultImage.src,
        srcSet,
        sizes: SIZES,
        width: defaultImage.attributes.width as number,
        height: defaultImage.attributes.height as number,
        alt: altText,
        loading: isFirst ? "eager" as const : "lazy" as const,
        decoding: "async" as const,
        fetchPriority: isFirst ? "high" as const : "auto" as const,
      },
    };
  })
);

const portfolioItems = processedItems.map((entry) => entry.data);
const showcaseMedia = processedItems.map((entry) => entry.mediaEntry);

---

<section
  id={id}
  class={`relative overflow-hidden p-6 ${className}`.trim()}
>
  <PortfolioScreenShowcase
    client:idle
    items={portfolioItems}
    mediaEntries={showcaseMedia}
    className="w-full mx-auto"
  />
</section>
