---
// PortfolioScreenVariant.astro
import { Image } from "astro:assets";
import type { BaseVariantProps } from "../ContentRenderer.types";
import PortfolioScreenShowcase from "@/components/LoopTemplates/PortfolioScreenShowcase";
import { getImageAlt, resolveImageMetadata } from "@/utils/images";
import { toArray } from "@/utils/array";

interface Props extends BaseVariantProps {}

const {
  items = [],
  className = "",
  id,
} = Astro.props as Props;

const safeItems = toArray(items);

if (!safeItems.length) {
  return;
}

const processedItems = safeItems.map((item, index) => {
  const primaryImage =
    (typeof item.image === "object" ? item.image : undefined) ??
    item.featuredImage ??
    item.bannerImage;

  const metadata = resolveImageMetadata(primaryImage);
  const altText = primaryImage
    ? getImageAlt(primaryImage, item.title ?? "Project preview")
    : item.title ?? "Project preview";

  return {
    data: item,
    mediaEntry:
      metadata && metadata.src
        ? {
            src: metadata.src,
            width: metadata.width,
            height: metadata.height,
            alt: altText,
          }
        : undefined,
    mediaMetadata: metadata,
    alt: altText,
  };
});

const portfolioItems = processedItems.map((entry) => entry.data);
const showcaseMedia = processedItems.map((entry) => entry.mediaEntry);
const showcaseOptimizedMedia = processedItems.map((entry) => entry.mediaMetadata);

---

<section
  id={id}
  class={`relative overflow-hidden p-6 ${className}`.trim()}
>
  <PortfolioScreenShowcase
    client:idle
    items={portfolioItems}
    mediaEntries={showcaseMedia}
    className="w-full mx-auto"
  >
    {showcaseOptimizedMedia.map((metadata, index) =>
      metadata ? (
        <Image
          key={portfolioItems[index]?.slug ?? `portfolio-image-${index}`}
          data-portfolio-media
          src={metadata}
          alt={processedItems[index]?.alt ?? portfolioItems[index]?.title ?? "Project preview"}
          loading={index === 0 ? "eager" : "lazy"}
          fetchpriority={index === 0 ? "high" : "low"}
          widths={[320, 480, 640, 860]}
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 430px"
          class="block w-full h-auto min-h-full select-none object-cover object-top"
          draggable="false"
        />
      ) : (
        <span
          key={`portfolio-placeholder-${index}`}
          data-portfolio-placeholder
          class="hidden"
        />
      )
    )}
  </PortfolioScreenShowcase>
</section>
