---
// src/components/ContentRenderer/variants/PortfolioVariant.astro
/**
 * Portfolio Variant
 * Renders featured projects inside the React-based PortfolioCarousel.
 */

import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import type { BaseVariantProps } from "../ContentRenderer.types";
import SectionHeader from "@/components/SectionHeader.astro";
import Button from "@/components/Button/Button";
import PortfolioCarousel from "@/components/LoopTemplates/PortfolioCarousel";
import { shouldShowCollectionCTA } from "../utils/helpers";
import type { ImageInput } from "@/content/schema";
import { getImageAlt } from "@/utils/images";

type AstroImageMetadata = ImageMetadata & { orientation?: number };

interface Props extends BaseVariantProps {
  autoplay?: boolean;
  autoAdvanceDelay?: number;
}

const {
  items = [],
  title,
  description,
  className = "",
  collectionUrl,
  collectionTitle,
  id,
  autoplay = true,
  autoAdvanceDelay = 7000,
} = Astro.props as Props;

const safeItems = Array.isArray(items) ? (items as Record<string, any>[]) : [];

const isImageMetadata = (img: unknown): img is AstroImageMetadata => {
  return Boolean(
    img &&
      typeof img === "object" &&
      "width" in img &&
      "height" in img &&
      "src" in img
  );
};

const resolveImageMetadata = (
  img?: ImageInput | null
): AstroImageMetadata | undefined => {
  if (!img) return undefined;

  if (isImageMetadata(img)) return img;

  if (
    typeof img === "object" &&
    "src" in img &&
    img.src &&
    isImageMetadata(img.src)
  ) {
    return img.src;
  }

  return undefined;
};

const processedItems = safeItems.map((item, index) => {
  const primaryImage =
    (typeof item.image === "object" ? item.image : undefined) ??
    item.featuredImage ??
    item.bannerImage;

  const metadata = resolveImageMetadata(primaryImage);
  const altText = primaryImage
    ? getImageAlt(primaryImage, item.title ?? "Project preview")
    : item.title ?? "Project preview";

  return {
    data: {
      ...item,
      ...(altText ? { alt: altText } : {}),
    },
    media: metadata
      ? {
          metadata,
          alt: altText,
          key: item.slug ?? item.id ?? `portfolio-${index}`,
        }
      : undefined,
  };
});

const portfolioItems = processedItems.map((entry) => entry.data);
const carouselMedia = processedItems.map((entry) => entry.media);

const fallbackTitle = title ?? collectionTitle ?? "Portfolio";
const headerTitle = title ?? fallbackTitle;
const headerEyebrow = headerTitle;
const showHeader = Boolean(headerTitle || description);
const ctaLabelSource = collectionTitle || headerTitle || "Projects";
const viewAllText = `View All ${ctaLabelSource}`.trim();
---

<section
  id={id}
  class={`outer-section bg-bg relative overflow-hidden ${className}`.trim()}
>
  <div class="section-dim-border"></div>

  <div class="">
    <SectionHeader
      title={headerEyebrow}
      heading={headerTitle}
      description={description}
      className="text-center"
      headingClassName="h2 mb-6"
      descriptionClassName="large-text max-w-2xl mx-auto"
    />

    <PortfolioCarousel
      client:visible
      items={portfolioItems}
      autoplay={autoplay}
      autoAdvanceDelay={autoAdvanceDelay}
      className={`${showHeader ? "mt-12" : ""}`.trim()}
    >
      {carouselMedia.map((media) =>
        media ? (
          <Image
            data-portfolio-media
            src={media.metadata}
            alt={media.alt}
            loading="lazy"
            widths={[480, 640, 860, 1024, 1280, 1600]}
            sizes="(max-width: 640px) 90vw, (max-width: 1024px) 70vw, 860px"
            class="block w-full h-auto min-h-full select-none object-cover object-top"
            draggable="false"
          />
        ) : (
          <span data-portfolio-placeholder class="hidden" />
        )
      )}
    </PortfolioCarousel>

    {shouldShowCollectionCTA(collectionUrl, portfolioItems.length) && (
      <div class="mt-12 text-center">
        <Button
          client:visible
          href={collectionUrl}
          rightIcon="lu:arrow-right"
          variant="secondary"
        >
          {viewAllText}
        </Button>
      </div>
    )}
  </div>
</section>
