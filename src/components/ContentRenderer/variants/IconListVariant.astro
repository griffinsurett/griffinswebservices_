---
// IconListVariant.astro
import type { BaseVariantProps } from "../ContentRenderer.types";
import IconListItem from "@/components/LoopComponents/IconListItem";
import SectionHeader from "@/components/SectionHeader.astro";
import { toArray } from "@/utils/array";
import Button from "@/components/Button/Button";

interface HeadingContent {
    title?: string;
    before?: string;
    text?: string;
    after?: string;
    description?: string;
}

interface Props extends BaseVariantProps {
    columns?: 1 | 2 | 3;
    gap?: "sm" | "md" | "lg";
    heading?: HeadingContent;
}

const {
    items = [],
    title,
    collectionTitle,
    heading,
    headingTag,
    headingClassName = "h2 text-heading",
    description,
    className = "",
    columns = 2,
    gap = "lg",
    id,
} = Astro.props as Props;

const safeItems = toArray(items);
const headingTitle = heading?.title ?? title ?? collectionTitle;
const headingBefore = heading?.before;
const headingText = heading?.text;
const headingAfter = heading?.after;
const headingDescription = heading?.description ?? description;
const showHeader = Boolean(
    headingTitle ??
        headingDescription ??
        headingBefore ??
        headingText ??
        headingAfter,
);

const gapClasses: Record<"sm" | "md" | "lg", string> = {
    sm: "gap-8",
    md: "gap-10",
    lg: "gap-12",
};

const resolveItemUrl = (item: Record<string, any>): string | undefined => {
    if (!item || typeof item !== "object") return undefined;
    const candidates = [
        item.url,
        item.href,
        item.link,
        item.route,
        item?.data?.url,
    ];
    return candidates.find(
        (value): value is string =>
            typeof value === "string" && value.trim().length > 0,
    );
};
---

<section id={id} class={`py-16 ${className}`.trim()}>
    <div class="mx-auto inner-section">
        <div
            class={`flex flex-col lg:space-x-25 gap-3 ${
                showHeader ? "lg:flex-row lg:items-start" : ""
            }`.trim()}
        >
            {
                showHeader && (
                    <div class="w-full lg:w-1/3 lg:sticky lg:top-0 lg:self-start">
                        <SectionHeader
                            title={headingTitle}
                            heading={headingText ?? headingTitle}
                            headingBefore={headingBefore}
                            headingEmphasis={headingText}
                            headingAfter={headingAfter}
                            description={headingDescription}
                            className="space-y-4 text-left"
                            headingTag={headingTag}
                            headingClassName={headingClassName}
                            descriptionClassName="text-lg text-muted leading-relaxed"
                            titleVisibleRootMargin={0}
                        />
                    </div>
                )
            }

            {
                safeItems.length > 0 && (
                    <div
                        class={`w-full py-6 lg:py-0 ${showHeader ? "lg:w-2/3" : ""}`.trim()}
                    >
                        <ul
                            class={`flex flex-col ${gapClasses[gap]} list-none`.trim()}
                        >
                            {safeItems.map((item) => {
                                const route = resolveItemUrl(item);
                                const linkLabel =
                                    typeof item?.title === "string"
                                        ? item.title
                                        : typeof item?.heading === "string"
                                          ? item.heading
                                          : "Open link";

                                const clickableWrapper = (content: any) =>
                                    route ? (
                                        <a
                                            href={route}
                                            class="block"
                                            aria-label={linkLabel}
                                        >
                                            {content}
                                        </a>
                                    ) : (
                                        content
                                    );

                                return (
                                    <li class="relative h-full group">
                                        {clickableWrapper(
                                            <div
                                                class={`${route ? "cursor-pointer hover:bg-bg3 p-10" : ""}`}
                                            >
                                                <IconListItem
                                                    data={item}
                                                    layout="vertical"
                                                    alignment="left"
                                                    className={`text-left gap-1 pr-12 ${route ? "group-hover:opacity-90 transition-opacity duration-300" : ""}`}
                                                    iconClassName="icon-large card-icon-color mb-3"
                                                    iconSize="xl"
                                                    titleClassName="text-heading h3"
                                                    descriptionClassName="text-base text-text"
                                                />
                                            </div>,
                                        )}

                                        {route && (
                                            <Button
                                                variant="arrowLink"
                                                href={route}
                                                className="absolute top-1/2 -translate-y-1/2 right-5 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-opacity duration-300"
                                                aria-label={`Open ${linkLabel}`}
                                            />
                                        )}
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                )
            }
        </div>
    </div>
</section>
