---
// src/layouts/collections/ServicesLayout.astro
/**
 * Services Layout - Unified Item Page Layout for Solutions & Capabilities
 *
 * A specialized layout for service-type collection items.
 * Features:
 * - QuoteHero with title, description, and quote form
 * - MDX content rendering
 * - Related items section (solutions show capabilities, capabilities show solutions)
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import QuoteHero from "@/layouts/QuoteHero.astro";
import ContentRenderer from "@/components/ContentRenderer/ContentRenderer.astro";
import { query, related, sortByDate } from "@/utils/query";
import { capitalizeWords } from "@/utils/string";
import { getItemKey } from "@/utils/collections/core";
import type { CollectionLayoutProps } from "./types";
import DoubleCard from "../DoubleCard.astro";

const {
  entry,
  collection,
  collectionMeta,
  Content,
  isIndexPage,
  seoProps = {},
  ...extraProps
} = Astro.props as CollectionLayoutProps;

const data = entry?.data || {};
const {
  title,
  description,
  price,
  parent,
  heading,
} = data;

// Get the current entry's slug for filtering related items
const currentSlug = entry ? getItemKey(entry) : "";

// Determine collection type for conditional rendering
const isCapabilities = collection === "capabilities";
const isSolutions = collection === "solutions";

const relatedSolutionsQuery = isCapabilities
  ? related("solutions", "capabilities", currentSlug)
  : null;

const relatedCapabilitiesQuery = isSolutions
  ? related("capabilities", "solutions", currentSlug)
  : null;

const relatedBlogsQuery = isCapabilities
  ? related("blog", "capabilities", currentSlug).orderBy(
      sortByDate("publishDate", "desc"),
    )
  : null;

// Build the description with price if available
const heroDescription = price ? `${description} ${price}` : description;

// Capitalize the slug for display
const displayTitle =
  title || capitalizeWords(entry?.slug?.replace(/-/g, " ") || "");
---

<BaseLayout {...seoProps}>
    {/* Quote Hero Section */}
    <QuoteHero
      title={title}
      heading={heading}
      description={heroDescription}
      primaryCTA={{
        text: `View All ${collectionMeta?.data?.title || "Services"}`,
        link: `/${collection}`,
        rightIcon: "lu:arrow-left",
      }}
      id="services-quote-hero"
    />

    {/* MDX Content */}
    {Content && <Content />}

    {isCapabilities && relatedSolutionsQuery && relatedBlogsQuery && (
      <>
        <ContentRenderer
          query={relatedSolutionsQuery}
          variant="CardVariant"
          title="Solutions"
          heading={{
            before: "Solutions that include",
            text: displayTitle,
          }}
          description={`Explore our website packages that include ${displayTitle.toLowerCase()} as part of the build.`}
          ctaHref="#services-quote-hero"
          ctaText="Get Your Free Quote"
          columns={3}
        />

        {/* <ContentRenderer
          query={relatedBlogsQuery}
          variant="BlogVariant"
          columns={3}
          title="Related Articles"
          heading={{
            before: "Learn more about",
            text: displayTitle,
          }}
          description={`Insights and guides related to ${displayTitle.toLowerCase()}.`}
        /> */}
      </>
    )}

    {isSolutions && relatedCapabilitiesQuery && (
      <ContentRenderer
        query={relatedCapabilitiesQuery}
        variant="CardVariant"
        title="Capabilities"
        heading={{
          before: "Capabilities inside",
          text: displayTitle,
        }}
        description={`Core skills and expertise packaged inside ${displayTitle.toLowerCase()}.`}
        columns={3}
      />
    )}
</BaseLayout>
