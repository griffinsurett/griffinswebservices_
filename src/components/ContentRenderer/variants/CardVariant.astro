---
// src/components/ContentRenderer/variants/CardVariant.astro
/**
 * Card Variant styled after our legacy WebsiteTypesSection
 * Retains ContentRenderer metadata + CTA behavior while reusing FeatureCard styling.
 */

import type { BaseVariantProps } from "../ContentRenderer.types";
import type { FeatureCardData } from "@/components/LoopComponents/FeatureCard";
import CardRenderer from "@/components/LoopTemplates/CardRenderer.astro";
import SectionHeader from "@/components/SectionHeader.astro";
import Button from "@/components/Button/Button";
import { shouldShowCollectionCTA } from "../utils/helpers";

interface Props extends BaseVariantProps {
  columns?: 1 | 2 | 3 | 4;
}

const {
  items = [],
  title,
  description,
  className = "outer-section bg-bg",
  columns = 3,
  collectionUrl,
  collectionTitle,
  id,
  showButtonSection = true,
} = Astro.props as Props;

const viewAllText = `Explore All ${collectionTitle || ""}`.trim();
const safeItems: FeatureCardData[] = Array.isArray(items)
  ? (items as FeatureCardData[])
  : [];

const itemToRecord = (item: FeatureCardData): Record<string, any> | null =>
  item && typeof item === "object" ? (item as Record<string, any>) : null;

const resolveCardClassName = (
  item: FeatureCardData,
  _index: number,
): string => {
  const record = itemToRecord(item);
  if (!record) return "";
  const classes = [record.class, record.className].filter(
    (value): value is string =>
      typeof value === "string" && value.trim().length > 0,
  );
  return classes.join(" ");
};

const resolveRingDuration = (item: FeatureCardData, _index: number): number => {
  const record = itemToRecord(item);
  return typeof record?.ringDuration === "number" ? record.ringDuration : 800;
};

const showHeader = Boolean(title || description);
const gridMarginClass = showHeader ? "mt-12" : "";
---

<section id={id} class={`relative overflow-hidden ${className}`.trim()}>
  <div class="section-dim-border"></div>

  <div class="inner-section">
    {
      showHeader && (
        <SectionHeader
          title={title}
          heading={title}
          description={description}
        />
      )
    }

    <CardRenderer
      items={safeItems}
      columns={columns}
      className={gridMarginClass}
      getCardClassName={resolveCardClassName}
      getRingDuration={resolveRingDuration}
    />

    {
      showButtonSection &&
        shouldShowCollectionCTA(collectionUrl, safeItems.length) && (
          <div class="buttons-section-center">
            <Button
              client:visible
              href={collectionUrl}
              rightIcon="lu:arrow-right"
              variant="secondary"
            >
              {viewAllText}
            </Button>
          </div>
        )
    }
  </div>
</section>
