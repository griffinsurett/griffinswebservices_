---
// src/layouts/collections/ServicesLayout.astro
/**
 * Services Layout - Item Page Layout for Solutions & Capabilities
 *
 * A specialized layout for service-type collection items.
 * Features:
 * - QuoteHero with title, description, and quote form
 * - Features list display
 * - MDX content rendering
 * - Related services section (siblings from same parent)
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
import QuoteHero from '@/layouts/QuoteHero.astro';
import ContentRenderer from '@/components/ContentRenderer/ContentRenderer.astro';
import CTASection from '@/layouts/CTASection.astro';
import { query, sortByOrder, related } from '@/utils/query';
import type { CollectionLayoutProps } from './types';
    
const {
  entry,
  collection,
  collectionMeta,
  Content,
  isIndexPage,
  seoProps = {},
  ...extraProps
} = Astro.props as CollectionLayoutProps;

const data = entry?.data || {};
const { title, description, price, features = [], parent, heading } = data;

// Get the current entry's slug for filtering related capabilities
const currentSlug = entry?.id;

// Get related items (siblings with same parent, excluding current item)
const relatedQuery = parent
  ? query(collection as any)
      .where((e: any) => e.data.parent === parent && e.id !== entry?.id)
      .orderBy(sortByOrder())
      .limit(6)
  : null;

// Query capabilities related to this solution using the `related` shortcut
const relatedCapabilitiesQuery = currentSlug
  ? related("capabilities", "solutions", currentSlug)
  : null;

// Build the description with price if available
const heroDescription = price
  ? `${description} ${price}`
  : description;
---
<BaseLayout {...seoProps}>
  <main class="flex-1">
    {/* Quote Hero Section */}
    <QuoteHero
      title={title}
      heading={heading}
      description={heroDescription}
      primaryCTA={{
        text: `View All ${collectionMeta?.data?.title || 'Services'}`,
        link: `/${collection}`,
        rightIcon: "lu:arrow-left"
      }}
      id='services-quote-hero'
    />

    {/* MDX Content */}
    {Content && (
      <Content />
    )}

    <ContentRenderer
      query={query("projects")}
      variant="PortfolioVariant"
      title="Our Work"
      heading={{
        before: "Websites we've",
        text: "designed & built",
        after: "for real clients.",
      }}
      description="Every project is custom-crafted to help businesses stand out and convert visitors into customers. Yours could be next."
      ctaHref="#services-quote-hero"
      ctaText="Get Your Free Quote"
    />

      <ContentRenderer
      query={query("testimonials")}
      variant="TestimonialCarouselVariant"
      />

      <ContentRenderer
        query={related("capabilities", "solutions", currentSlug)}
        variant="CardVariant"
        title="What You Get"
        heading={{
          before: "Everything included in your",
          text: title,
          after: "build.",
        }}
        description={`No surprises, no upsellsâ€”just the full package to get your ${title?.toLowerCase()} live and performing.`}
        ctaHref="#services-quote-hero"
        ctaText="Get Your Free Quote"
      />

    <CTASection
      id="services-page-cta"
      className="min-h-[60vh]"
      title={`Ready to get started with a ${entry.slug}?`}
      heading={{
        before: "Let's build your",
        text: entry.slug,
        after: " today.",
      }}
      primaryCTA={{
        text: "Get Your Free Quote",
        link: "#services-quote-hero",
      }}
    />
  </main>
</BaseLayout>
