---
// PortfolioScreenVariant.astro
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import type { BaseVariantProps } from "../ContentRenderer.types";
import PortfolioScreenShowcase from "@/components/LoopTemplates/PortfolioScreenShowcase";
import type { ImageInput } from "@/content/schema";
import { getImageAlt } from "@/utils/images";
import { toArray } from "@/utils/array";

interface Props extends BaseVariantProps {}

const {
  items = [],
  title,
  description,
  className = "",
  collectionUrl,
  collectionTitle,
  id,
} = Astro.props as Props;

const safeItems = toArray(items);

if (!safeItems.length) {
  return;
}

const isImageMetadata = (img: unknown): img is ImageMetadata => {
  return Boolean(
    img &&
      typeof img === "object" &&
      "width" in img &&
      "height" in img &&
      "src" in img
  );
};

const resolveImageMetadata = (
  img?: ImageInput | null
): ImageMetadata | undefined => {
  if (!img) return undefined;

  if (isImageMetadata(img)) return img;

  if (
    typeof img === "object" &&
    "src" in img &&
    img.src &&
    isImageMetadata(img.src)
  ) {
    return img.src;
  }

  return undefined;
};

const processedItems = safeItems.map((item, index) => {
  const primaryImage =
    (typeof item.image === "object" ? item.image : undefined) ??
    item.featuredImage ??
    item.bannerImage;

  const metadata = resolveImageMetadata(primaryImage);
  const altText = primaryImage
    ? getImageAlt(primaryImage, item.title ?? "Project preview")
    : item.title ?? "Project preview";

  return {
    data: item,
    mediaEntry:
      metadata && metadata.src
        ? {
            src: metadata.src,
            width: metadata.width,
            height: metadata.height,
            alt: altText,
          }
        : undefined,
    mediaMetadata: metadata,
    alt: altText,
  };
});

const portfolioItems = processedItems.map((entry) => entry.data);
const showcaseMedia = processedItems.map((entry) => entry.mediaEntry);
const showcaseOptimizedMedia = processedItems.map((entry) => entry.mediaMetadata);

---

<section
  id={id}
  class={`relative rounded-lg overflow-hidden p-6 ${className}`.trim()}
>
  <PortfolioScreenShowcase
    client:idle
    items={portfolioItems}
    mediaEntries={showcaseMedia}
    className="w-full mx-auto"
  >
    {showcaseOptimizedMedia.map((metadata, index) =>
      metadata ? (
        <Image
          key={portfolioItems[index]?.slug ?? `portfolio-image-${index}`}
          data-portfolio-media
          src={metadata}
          alt={processedItems[index]?.alt ?? portfolioItems[index]?.title ?? "Project preview"}
          loading={index === 0 ? "eager" : "lazy"}
          fetchpriority={index === 0 ? "high" : "low"}
          sizes="(max-width: 640px) 90vw, (max-width: 1024px) 70vw, 860px"
          class="block w-full h-auto min-h-full select-none object-cover object-top"
          draggable="false"
        />
      ) : (
        <span
          key={`portfolio-placeholder-${index}`}
          data-portfolio-placeholder
          class="hidden"
        />
      )
    )}
  </PortfolioScreenShowcase>
</section>
