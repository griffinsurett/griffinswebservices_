---
import type { BaseVariantProps } from "../ContentRenderer.types";
import IconListItem from "@/components/LoopComponents/IconListItem";
import SectionHeader from "@/components/SectionHeader.astro";
import { toArray } from "@/utils/array";
import Button from "@/components/Button/Button";
import type { HeadingContent as SchemaHeadingContent } from "@/content/schema";

type SegmentedHeading = Extract<SchemaHeadingContent, Record<string, any>>;

interface HeadingContent extends Partial<SegmentedHeading> {
  title?: string;
  description?: string;
}

interface Props extends BaseVariantProps {
  columns?: 1 | 2 | 3;
  gap?: "sm" | "md" | "lg";
  heading?: HeadingContent;
}

const {
  items = [],
  title,
  collectionTitle,
  heading,
  description,
  className = "",
  columns = 2,
  gap = "md",
  id,
} = Astro.props as Props;

const safeItems = toArray(items);
const headingTitle = heading?.title ?? title ?? collectionTitle;
const headingBefore = heading?.before;
const headingText = heading?.text;
const headingAfter = heading?.after;
const headingDescription = heading?.description ?? description;
const hasSegmentedHeading = Boolean(headingBefore ?? headingText ?? headingAfter);
const fallbackHeadingText = headingText ?? headingTitle ?? collectionTitle;
const headingValue: SchemaHeadingContent | string | undefined = hasSegmentedHeading
  ? fallbackHeadingText
    ? {
        before: headingBefore,
        text: fallbackHeadingText,
        after: headingAfter,
      }
    : undefined
  : fallbackHeadingText;
const showHeader = Boolean(
  headingTitle ?? headingDescription ?? headingBefore ?? headingText ?? headingAfter,
);

const gapClasses: Record<"sm" | "md" | "lg", string> = {
  sm: "gap-6",
  md: "gap-8",
  lg: "gap-10",
};

const resolveItemUrl = (item: Record<string, any>): string | undefined => {
  if (!item || typeof item !== "object") return undefined;
  const candidates = [
    item.url,
    item.href,
    item.link,
    item.route,
    item?.data?.url,
  ];
  return candidates.find(
    (value): value is string => typeof value === "string" && value.trim().length > 0,
  );
};
---

<section id={id} class={`py-16 ${className}`.trim()}>
  <div class="mx-auto inner-section">
    <div
      class={`flex flex-col lg:space-x-25 gap-6 ${
        showHeader ? "lg:flex-row lg:items-start" : ""
      }`.trim()}
    >
      {showHeader && (
        <div class="w-full lg:w-1/3 lg:sticky lg:top-0 lg:self-start">
          <SectionHeader
            title={headingTitle}
            heading={headingValue}
            description={headingDescription}
            className="space-y-4 text-left"
            headingClassName="h2 text-heading"
            descriptionClassName="text-lg text-muted leading-relaxed"
            titleVisibleRootMargin={0}
          />
        </div>
      )}

      {safeItems.length > 0 && (
        <div class={`w-full py-6 lg:py-0 ${showHeader ? "lg:w-2/3" : ""}`.trim()}>
          <ul class={`flex flex-col ${gapClasses[gap]} list-none`.trim()}>
            {safeItems.map((item) => {
              const route = resolveItemUrl(item);
              const linkLabel =
                typeof item?.title === "string"
                  ? item.title
                  : typeof item?.heading === "string"
                  ? item.heading
                  : "Open link";

              return (
                <li class="h-full">
                  <div
                    class={`flex items-center gap-5 p-6 transition-colors hover:bg-bg3 ${
                      route ? "group cursor-pointer" : ""
                    }`.trim()}
                  >
                    <div class="flex-1">
                      <IconListItem
                        data={item}
                        layout="vertical"
                        alignment="left"
                        className="items-start text-left gap-1"
                        iconClassName="icon-large card-icon-color mb-3"
                        iconSize="xl"
                        titleClassName="h3 text-heading"
                        descriptionClassName="text-base text-muted leading-relaxed"
                      />
                    </div>

                    {route && (
                      <span class="opacity-0 transition-opacity duration-300 group-hover:opacity-100 group-hover:animate-bounce">
                        <Button
                          client:visible
                          variant="arrowLink"
                          href={route}
                          aria-label={`Open ${linkLabel}`}
                        >
                          <span class="sr-only">{linkLabel}</span>
                        </Button>
                      </span>
                    )}
                  </div>
                </li>
              );
            })}
          </ul>
        </div>
      )}
    </div>
  </div>
</section>
