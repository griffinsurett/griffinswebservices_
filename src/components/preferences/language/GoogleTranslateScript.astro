---
// src/components/preferences/language/GoogleTranslateScript.astro
/**
 * Google Translate Integration Script
 *
 * Provides a lightweight wrapper that only loads the Google Translate script
 * when necessary and avoids full page reloads when switching languages.
 */
---
<script>
  import { setCookie, clearCookie } from "@/utils/cookies";
  import { getStorageItem, setStorageItem } from "@/utils/storage";
  import { hasConsentFor } from "@/utils/consent/consent";

  declare global {
    interface Window {
      initializeGoogleTranslate?: () => void;
      changeLanguage?: (languageCode: string) => void;
    }
  }

  const STORAGE_KEY = "user-language";
  const GOOGLE_SCRIPT_ID = "google-translate-sdk";

  interface TranslateState {
    scriptRequested: boolean;
    translateInitialized: boolean;
    pendingLanguage: string | null;
  }

  const state: TranslateState = {
    scriptRequested: false,
    translateInitialized: false,
    pendingLanguage: null,
  };

  function normalizeLanguage(code: string | null): string {
    return code || "en";
  }

  function persistLanguagePreference(languageCode: string) {
    setStorageItem(STORAGE_KEY, languageCode);

    if (!hasConsentFor("functional")) {
      if (languageCode === "en") {
        clearCookie("googtrans");
      }
      return;
    }

    if (languageCode === "en") {
      clearCookie("googtrans");
    } else {
      setCookie("googtrans", `/en/${languageCode}`, { expires: 365, sameSite: "Lax" });
    }
  }

  function ensureTranslateScript() {
    if (state.scriptRequested || state.translateInitialized) {
      return;
    }

    if (!hasConsentFor("functional")) {
      console.warn("Functional consent required to load Google Translate");
      return;
    }

    const existing = document.getElementById(GOOGLE_SCRIPT_ID);
    if (existing) {
      state.scriptRequested = true;
      return;
    }

    state.scriptRequested = true;

    const script = document.createElement("script");
    script.id = GOOGLE_SCRIPT_ID;
    script.src = "https://translate.google.com/translate_a/element.js?cb=initializeGoogleTranslate";
    script.async = true;
    script.onerror = () => {
      state.scriptRequested = false;
      console.error("Failed to load Google Translate script");
    };

    document.head.appendChild(script);
  }

  function applyLanguage(languageCode: string): boolean {
    const combo = document.querySelector("select.goog-te-combo");
    if (!(combo instanceof HTMLSelectElement)) {
      return false;
    }

    const normalized = languageCode === "en" ? "" : languageCode;

    if (combo.value === normalized) {
      state.pendingLanguage = null;
      return true;
    }

    combo.value = normalized;
    combo.dispatchEvent(new Event("change"));
    if (normalized) {
      document.documentElement.dataset.preferredLanguage = languageCode;
    } else {
      document.documentElement.removeAttribute("data-preferred-language");
    }
    state.pendingLanguage = null;
    return true;
  }

  window.initializeGoogleTranslate = function () {
    const google = (window as any).google;
    if (!google?.translate?.TranslateElement) {
      state.scriptRequested = false;
      return;
    }

    new google.translate.TranslateElement(
      {
        pageLanguage: "en",
        includedLanguages: "",
        autoDisplay: false,
      },
      "google_translate_element",
    );

    state.translateInitialized = true;

    const desiredLanguage = state.pendingLanguage || normalizeLanguage(getStorageItem(STORAGE_KEY));
    if (desiredLanguage && desiredLanguage !== "en") {
      requestAnimationFrame(() => applyLanguage(desiredLanguage));
    }
  };

  window.changeLanguage = function (languageCode: string) {
    const normalized = normalizeLanguage(languageCode);
    persistLanguagePreference(normalized);

    if (normalized === "en") {
      document.documentElement.removeAttribute("data-preferred-language");
      if (state.translateInitialized) {
        applyLanguage("en");
      } else {
        state.pendingLanguage = null;
      }
      return;
    }

    state.pendingLanguage = normalized;

    if (!hasConsentFor("functional")) {
      console.warn("Functional consent required to change languages");
      return;
    }

    ensureTranslateScript();

    if (state.translateInitialized) {
      applyLanguage(normalized);
    }
  };

  const savedLanguage = normalizeLanguage(getStorageItem(STORAGE_KEY));
  if (savedLanguage !== "en" && hasConsentFor("functional")) {
    persistLanguagePreference(savedLanguage);
    state.pendingLanguage = savedLanguage;
    ensureTranslateScript();
  }

  window.addEventListener("consent-changed", () => {
    if (!hasConsentFor("functional")) {
      return;
    }

    const preferred = normalizeLanguage(getStorageItem(STORAGE_KEY));
    if (preferred === "en") {
      return;
    }

    persistLanguagePreference(preferred);
    state.pendingLanguage = preferred;

    if (state.translateInitialized) {
      applyLanguage(preferred);
    } else {
      ensureTranslateScript();
    }
  });
</script>

<div id="google_translate_element" style="display: none;"></div>

<style>
  .goog-te-banner-frame,
  .goog-te-balloon-frame,
  .goog-te-gadget,
  .skiptranslate,
  iframe.goog-te-menu-frame,
  #google_translate_element,
  body > .skiptranslate,
  iframe.skiptranslate {
    display: none !important;
  }

  body {
    top: 0 !important;
  }
</style>
